<!-- GoodWe Node Configuration -->
<script type="text/javascript">
    RED.nodes.registerType('goodwe', {
        category: 'advanced',
        color: '#3FADB5',
        defaults: {
            name: { value: "" },
            config: { value: "", type: "goodwe-config", required: true }
        },
        inputs: 1,
        outputs: 1,
        icon: "bridge.png",
        label: function() {
            if (this.name) {
                return this.name;
            }
            // Show config name
            if (this.config) {
                const configNode = RED.nodes.node(this.config);
                if (configNode && configNode.name) {
                    return "GoodWe " + configNode.name;
                }
                return "GoodWe (config)";
            }
            return "GoodWe";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            // No additional setup needed
        }
    });
</script>

<!-- Node Configuration Template -->
<script type="text/html" data-template-name="goodwe">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-cog"></i> Configuration</label>
        <input type="text" id="node-input-config">
    </div>
</script>

<!-- Node Help Text -->
<script type="text/html" data-help-name="goodwe">
    <p>A Node-RED node for connecting to GoodWe inverters and retrieving sensor data.</p>
    
    <h3>Configuration</h3>
    <p>This node requires a GoodWe configuration node to define connection settings.</p>
    
    <dl class="message-properties">
        <dt>Configuration <span class="property-type">goodwe-config</span></dt>
        <dd>Reference to a shared GoodWe configuration node (required). Click the pencil icon to create or edit a configuration node.</dd>
    </dl>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object | string</span></dt>
        <dd>Command to execute. Can be a string like "read", "discover" or an object with command and parameters.</dd>
    </dl>

    <h4>Commands</h4>
    <dl class="message-properties">
        <dt>read <span class="property-type">string</span></dt>
        <dd>Read runtime sensor data from the inverter</dd>

        <dt>discover <span class="property-type">string</span></dt>
        <dd>Discover inverters on the local network</dd>

        <dt>read_settings <span class="property-type">object</span></dt>
        <dd>Read all configuration settings from the inverter. Example: <code>{ command: "read_settings" }</code></dd>

        <dt>read_setting <span class="property-type">object</span></dt>
        <dd>Read a specific configuration setting. Example: <code>{ command: "read_setting", setting_id: "grid_export_limit" }</code></dd>

        <dt>write_setting <span class="property-type">object</span></dt>
        <dd><strong>⚠️ WARNING:</strong> Write a configuration setting. This modifies installer-level parameters. Use with extreme caution!<br>
        Example: <code>{ command: "write_setting", setting_id: "grid_export_limit", value: 5000 }</code></dd>

        <dt>get_grid_export_limit <span class="property-type">object</span></dt>
        <dd>Get the current grid export limit in watts. Example: <code>{ command: "get_grid_export_limit" }</code></dd>

        <dt>set_grid_export_limit <span class="property-type">object</span></dt>
        <dd><strong>⚠️ WARNING:</strong> Set the grid export limit in watts (0-10000W). Example: <code>{ command: "set_grid_export_limit", limit: 5000 }</code></dd>

        <dt>get_operation_mode <span class="property-type">object</span></dt>
        <dd>Get the current operation mode. Example: <code>{ command: "get_operation_mode" }</code></dd>

        <dt>set_operation_mode <span class="property-type">object</span></dt>
        <dd><strong>⚠️ WARNING:</strong> Set the operation mode (GENERAL, OFF_GRID, BACKUP, ECO, PEAK_SHAVING).<br>
        Example: <code>{ command: "set_operation_mode", mode: "ECO", eco_mode_power: 100, eco_mode_soc: 90 }</code></dd>

        <dt>get_battery_dod <span class="property-type">object</span></dt>
        <dd>Get battery depth of discharge (DoD) in %. Example: <code>{ command: "get_battery_dod" }</code></dd>

        <dt>set_battery_dod <span class="property-type">object</span></dt>
        <dd><strong>⚠️ WARNING:</strong> Set battery depth of discharge (0-89%). Example: <code>{ command: "set_battery_dod", dod: 85 }</code></dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Response object containing success status, command, timestamp, and data/error</dd>
    </dl>

    <h3>Details</h3>
    <p>This node connects to GoodWe inverters over the local network to retrieve runtime sensor values
    and configuration parameters. It supports both UDP (port 8899) and Modbus TCP (port 502) protocols.</p>
    
    <p>The node is based on the <code>marcelblijleven/goodwe</code> Python library and supports
    multiple inverter families including ET, EH, BT, BH, ES, EM, BP, DT, MS, D-NS, and XS series.</p>

    <h4>Configuration Read/Write</h4>
    <p><strong style="color: red;">⚠️ CRITICAL WARNING:</strong> Configuration write operations modify installer-level parameters
    that can affect inverter operation, safety, and warranty. Incorrect values may damage equipment, create unsafe conditions,
    void your warranty, or violate local electrical codes and grid connection requirements.</p>
    
    <p><strong>Safety Guidelines:</strong></p>
    <ul>
        <li><strong>Backup current settings:</strong> Always read and save current settings before making changes</li>
        <li><strong>Validate parameter values:</strong> Ensure values are within safe ranges for your specific installation</li>
        <li><strong>Document all changes:</strong> Keep a record of what was changed, when, and why</li>
        <li><strong>Consult documentation:</strong> Review inverter manual and local regulations before modifying settings</li>
        <li><strong>Professional consultation:</strong> Contact your installer or manufacturer for complex changes</li>
        <li><strong>Warranty implications:</strong> Unauthorized modifications may void warranty coverage</li>
        <li><strong>Test carefully:</strong> Monitor inverter behavior closely after any configuration change</li>
    </ul>

    <p><strong>Supported Settings:</strong></p>
    <ul>
        <li><strong>grid_export_limit:</strong> Maximum power export to grid (0-10000W)</li>
        <li><strong>operation_mode:</strong> Inverter operation mode (GENERAL, OFF_GRID, BACKUP, ECO, PEAK_SHAVING)</li>
        <li><strong>battery_dod:</strong> Battery depth of discharge limit (0-89%)</li>
    </ul>

    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/marcelblijleven/goodwe">marcelblijleven/goodwe Python library</a></li>
        <li><a href="https://github.com/pkot/node-red-contrib-goodwe">node-red-contrib-goodwe GitHub repository</a></li>
    </ul>
</script>
