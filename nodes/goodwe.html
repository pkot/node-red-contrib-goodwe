<!-- GoodWe Node Configuration -->
<script type="text/javascript">
    RED.nodes.registerType('goodwe', {
        category: 'advanced',
        color: '#3FADB5',
        defaults: {
            name: { value: "" },
            host: { value: "", required: true, validate: RED.validators.regex(/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$|^[a-zA-Z0-9.-]+$/) },
            port: { value: 8899, required: true, validate: RED.validators.number() },
            protocol: { value: "udp" },
            family: { value: "ET" }
        },
        inputs: 1,
        outputs: 1,
        icon: "bridge.png",
        label: function() {
            return this.name || "GoodWe " + (this.host || "inverter");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            // Update port based on protocol selection
            $("#node-input-protocol").change(function() {
                const protocol = $(this).val();
                if (protocol === "udp") {
                    $("#node-input-port").val(8899);
                } else if (protocol === "modbus") {
                    $("#node-input-port").val(502);
                }
            });
        }
    });
</script>

<!-- Node Configuration Template -->
<script type="text/html" data-template-name="goodwe">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-host"><i class="fa fa-server"></i> Host</label>
        <input type="text" id="node-input-host" placeholder="192.168.1.100 or inverter.local">
    </div>
    <div class="form-row">
        <label for="node-input-protocol"><i class="fa fa-exchange"></i> Protocol</label>
        <select id="node-input-protocol">
            <option value="udp">UDP</option>
            <option value="modbus">Modbus TCP</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-plug"></i> Port</label>
        <input type="number" id="node-input-port" placeholder="8899">
    </div>
    <div class="form-row">
        <label for="node-input-family"><i class="fa fa-microchip"></i> Inverter Family</label>
        <select id="node-input-family">
            <option value="ET">ET Series</option>
            <option value="EH">EH Series</option>
            <option value="BT">BT Series</option>
            <option value="BH">BH Series</option>
            <option value="ES">ES Series</option>
            <option value="EM">EM Series</option>
            <option value="BP">BP Series</option>
            <option value="DT">DT Series</option>
            <option value="MS">MS Series</option>
            <option value="D-NS">D-NS Series</option>
            <option value="XS">XS Series</option>
        </select>
    </div>
</script>

<!-- Node Help Text -->
<script type="text/html" data-help-name="goodwe">
    <p>A Node-RED node for connecting to GoodWe inverters and retrieving sensor data.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Host <span class="property-type">string</span></dt>
        <dd>IP address or hostname of the GoodWe inverter</dd>
        
        <dt>Protocol <span class="property-type">string</span></dt>
        <dd>Communication protocol: UDP (port 8899) or Modbus TCP (port 502)</dd>
        
        <dt>Port <span class="property-type">number</span></dt>
        <dd>Communication port (default: 8899 for UDP, 502 for Modbus)</dd>
        
        <dt>Inverter Family <span class="property-type">string</span></dt>
        <dd>The series/family of your GoodWe inverter (ET, EH, BT, BH, ES, EM, BP, DT, MS, D-NS, XS)</dd>
    </dl>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object | string</span></dt>
        <dd>Command to execute: "read" for runtime data, "discover" for device discovery</dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Sensor data and runtime information from the inverter</dd>
    </dl>

    <h3>Details</h3>
    <p>This node connects to GoodWe inverters over the local network to retrieve runtime sensor values
    and configuration parameters. It supports both UDP (port 8899) and Modbus TCP (port 502) protocols.</p>
    
    <p>The node is based on the <code>marcelblijleven/goodwe</code> Python library and supports
    multiple inverter families including ET, EH, BT, BH, ES, EM, BP, DT, MS, D-NS, and XS series.</p>

    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/marcelblijleven/goodwe">marcelblijleven/goodwe Python library</a></li>
        <li><a href="https://github.com/pkot/node-red-contrib-goodwe">node-red-contrib-goodwe GitHub repository</a></li>
    </ul>
</script>
