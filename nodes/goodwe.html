<!-- GoodWe Node Configuration -->
<script type="text/javascript">
    RED.nodes.registerType('goodwe', {
        category: 'advanced',
        color: '#3FADB5',
        defaults: {
            name: { value: "" },
            config: { value: "", type: "goodwe-config" },
            host: { value: "", validate: function(v) {
                // Host is required if config is not set
                if (!this.config && (!v || v === "")) {
                    return false;
                }
                // If host is provided, validate format
                if (v && v !== "") {
                    return RED.validators.regex(/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$|^[a-zA-Z0-9.-]+$/)(v);
                }
                return true;
            }},
            port: { value: 8899, validate: function(v) {
                // Port is required if config is not set
                if (!this.config && (!v || v === "")) {
                    return false;
                }
                // If port is provided, validate it's a number
                if (v && v !== "") {
                    return RED.validators.number()(v);
                }
                return true;
            }},
            protocol: { value: "udp" },
            family: { value: "ET" }
        },
        inputs: 1,
        outputs: 1,
        icon: "bridge.png",
        label: function() {
            if (this.name) {
                return this.name;
            }
            // If using config node, show config name
            if (this.config) {
                const configNode = RED.nodes.node(this.config);
                if (configNode && configNode.name) {
                    return "GoodWe " + configNode.name;
                }
                return "GoodWe (config)";
            }
            // Otherwise use host
            return "GoodWe " + (this.host || "inverter");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            // Handle config node vs inline configuration
            const toggleConfigMode = () => {
                const useConfig = $("#node-input-use-config").is(":checked");
                if (useConfig) {
                    $("#inline-config-section").hide();
                    $("#config-node-section").show();
                } else {
                    $("#inline-config-section").show();
                    $("#config-node-section").hide();
                }
            };
            
            // Initialize toggle based on whether config is set
            if (this.config) {
                $("#node-input-use-config").prop("checked", true);
            } else {
                $("#node-input-use-config").prop("checked", false);
            }
            toggleConfigMode();
            
            $("#node-input-use-config").change(toggleConfigMode);
            
            // Update port based on protocol selection
            $("#node-input-protocol").change(function() {
                const protocol = $(this).val();
                if (protocol === "udp") {
                    $("#node-input-port").val(8899);
                } else if (protocol === "modbus") {
                    $("#node-input-port").val(502);
                }
            });
        }
    });
</script>

<!-- Node Configuration Template -->
<script type="text/html" data-template-name="goodwe">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-use-config" style="display: inline-block; width: auto; vertical-align: top;">
        <span style="margin-left: 5px;">Use shared configuration node</span>
    </div>
    
    <div id="config-node-section">
        <div class="form-row">
            <label for="node-input-config"><i class="fa fa-cog"></i> Configuration</label>
            <input type="text" id="node-input-config">
        </div>
    </div>
    
    <div id="inline-config-section">
        <div class="form-row">
            <label for="node-input-host"><i class="fa fa-server"></i> Host</label>
            <input type="text" id="node-input-host" placeholder="192.168.1.100 or inverter.local">
        </div>
        <div class="form-row">
            <label for="node-input-protocol"><i class="fa fa-exchange"></i> Protocol</label>
            <select id="node-input-protocol">
                <option value="udp">UDP</option>
                <option value="modbus">Modbus TCP</option>
            </select>
        </div>
        <div class="form-row">
            <label for="node-input-port"><i class="fa fa-plug"></i> Port</label>
            <input type="number" id="node-input-port" placeholder="8899">
        </div>
        <div class="form-row">
            <label for="node-input-family"><i class="fa fa-microchip"></i> Inverter Family</label>
            <select id="node-input-family">
                <option value="ET">ET Series</option>
                <option value="EH">EH Series</option>
                <option value="BT">BT Series</option>
                <option value="BH">BH Series</option>
                <option value="ES">ES Series</option>
                <option value="EM">EM Series</option>
                <option value="BP">BP Series</option>
                <option value="DT">DT Series</option>
                <option value="MS">MS Series</option>
                <option value="D-NS">D-NS Series</option>
                <option value="XS">XS Series</option>
            </select>
        </div>
    </div>
</script>

<!-- Node Help Text -->
<script type="text/html" data-help-name="goodwe">
    <p>A Node-RED node for connecting to GoodWe inverters and retrieving sensor data.</p>
    
    <h3>Configuration</h3>
    <p>This node supports two configuration modes:</p>
    <ul>
        <li><strong>Shared Configuration Node</strong> - Use a reusable configuration node (recommended for multiple nodes)</li>
        <li><strong>Inline Configuration</strong> - Configure connection settings directly in this node</li>
    </ul>
    
    <dl class="message-properties">
        <dt>Configuration <span class="property-type">goodwe-config</span></dt>
        <dd>Reference to a shared GoodWe configuration node (when using shared configuration mode)</dd>
        
        <dt>Host <span class="property-type">string</span></dt>
        <dd>IP address or hostname of the GoodWe inverter (when using inline configuration)</dd>
        
        <dt>Protocol <span class="property-type">string</span></dt>
        <dd>Communication protocol: UDP (port 8899) or Modbus TCP (port 502)</dd>
        
        <dt>Port <span class="property-type">number</span></dt>
        <dd>Communication port (default: 8899 for UDP, 502 for Modbus)</dd>
        
        <dt>Inverter Family <span class="property-type">string</span></dt>
        <dd>The series/family of your GoodWe inverter (ET, EH, BT, BH, ES, EM, BP, DT, MS, D-NS, XS)</dd>
    </dl>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object | string</span></dt>
        <dd>Command to execute. Can be a string like "read", "discover" or an object with command and parameters.</dd>
    </dl>

    <h4>Commands</h4>
    <dl class="message-properties">
        <dt>read <span class="property-type">string</span></dt>
        <dd>Read runtime sensor data from the inverter</dd>

        <dt>discover <span class="property-type">string</span></dt>
        <dd>Discover inverters on the local network</dd>

        <dt>read_settings <span class="property-type">object</span></dt>
        <dd>Read all configuration settings from the inverter. Example: <code>{ command: "read_settings" }</code></dd>

        <dt>read_setting <span class="property-type">object</span></dt>
        <dd>Read a specific configuration setting. Example: <code>{ command: "read_setting", setting_id: "grid_export_limit" }</code></dd>

        <dt>write_setting <span class="property-type">object</span></dt>
        <dd><strong>⚠️ WARNING:</strong> Write a configuration setting. This modifies installer-level parameters. Use with extreme caution!<br>
        Example: <code>{ command: "write_setting", setting_id: "grid_export_limit", value: 5000 }</code></dd>

        <dt>get_grid_export_limit <span class="property-type">object</span></dt>
        <dd>Get the current grid export limit in watts. Example: <code>{ command: "get_grid_export_limit" }</code></dd>

        <dt>set_grid_export_limit <span class="property-type">object</span></dt>
        <dd><strong>⚠️ WARNING:</strong> Set the grid export limit in watts (0-10000W). Example: <code>{ command: "set_grid_export_limit", limit: 5000 }</code></dd>

        <dt>get_operation_mode <span class="property-type">object</span></dt>
        <dd>Get the current operation mode. Example: <code>{ command: "get_operation_mode" }</code></dd>

        <dt>set_operation_mode <span class="property-type">object</span></dt>
        <dd><strong>⚠️ WARNING:</strong> Set the operation mode (GENERAL, OFF_GRID, BACKUP, ECO, PEAK_SHAVING).<br>
        Example: <code>{ command: "set_operation_mode", mode: "ECO", eco_mode_power: 100, eco_mode_soc: 90 }</code></dd>

        <dt>get_battery_dod <span class="property-type">object</span></dt>
        <dd>Get battery depth of discharge (DoD) in %. Example: <code>{ command: "get_battery_dod" }</code></dd>

        <dt>set_battery_dod <span class="property-type">object</span></dt>
        <dd><strong>⚠️ WARNING:</strong> Set battery depth of discharge (0-89%). Example: <code>{ command: "set_battery_dod", dod: 85 }</code></dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Response object containing success status, command, timestamp, and data/error</dd>
    </dl>

    <h3>Details</h3>
    <p>This node connects to GoodWe inverters over the local network to retrieve runtime sensor values
    and configuration parameters. It supports both UDP (port 8899) and Modbus TCP (port 502) protocols.</p>
    
    <p>The node is based on the <code>marcelblijleven/goodwe</code> Python library and supports
    multiple inverter families including ET, EH, BT, BH, ES, EM, BP, DT, MS, D-NS, and XS series.</p>

    <h4>Configuration Read/Write</h4>
    <p><strong style="color: red;">⚠️ CRITICAL WARNING:</strong> Configuration write operations modify installer-level parameters
    that can affect inverter operation, safety, and warranty. Incorrect values may damage equipment, create unsafe conditions,
    void your warranty, or violate local electrical codes and grid connection requirements.</p>
    
    <p><strong>Safety Guidelines:</strong></p>
    <ul>
        <li><strong>Backup current settings:</strong> Always read and save current settings before making changes</li>
        <li><strong>Validate parameter values:</strong> Ensure values are within safe ranges for your specific installation</li>
        <li><strong>Document all changes:</strong> Keep a record of what was changed, when, and why</li>
        <li><strong>Consult documentation:</strong> Review inverter manual and local regulations before modifying settings</li>
        <li><strong>Professional consultation:</strong> Contact your installer or manufacturer for complex changes</li>
        <li><strong>Warranty implications:</strong> Unauthorized modifications may void warranty coverage</li>
        <li><strong>Test carefully:</strong> Monitor inverter behavior closely after any configuration change</li>
    </ul>

    <p><strong>Supported Settings:</strong></p>
    <ul>
        <li><strong>grid_export_limit:</strong> Maximum power export to grid (0-10000W)</li>
        <li><strong>operation_mode:</strong> Inverter operation mode (GENERAL, OFF_GRID, BACKUP, ECO, PEAK_SHAVING)</li>
        <li><strong>battery_dod:</strong> Battery depth of discharge limit (0-89%)</li>
    </ul>

    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/marcelblijleven/goodwe">marcelblijleven/goodwe Python library</a></li>
        <li><a href="https://github.com/pkot/node-red-contrib-goodwe">node-red-contrib-goodwe GitHub repository</a></li>
    </ul>
</script>
