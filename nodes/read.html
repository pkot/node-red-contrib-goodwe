<!-- GoodWe Read Node Configuration -->
<script type="text/javascript">
    RED.nodes.registerType('goodwe-read', {
        category: 'GoodWe',
        color: '#3FADB5',
        defaults: {
            name: { value: "" },
            config: { value: "", type: "goodwe-config", required: true },
            outputFormat: { value: "flat" },
            pollingInterval: { value: 0, validate: RED.validators.number() }
        },
        inputs: 1,
        outputs: 1,
        icon: "bridge.png",
        label: function() {
            return this.name || "read";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        }
    });
</script>

<!-- Node Configuration Template -->
<script type="text/html" data-template-name="goodwe-read">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-cog"></i> Config</label>
        <input type="text" id="node-input-config" placeholder="Select configuration">
    </div>
    
    <div class="form-row">
        <label for="node-input-outputFormat"><i class="fa fa-list"></i> Output Format</label>
        <select id="node-input-outputFormat">
            <option value="flat">Flat (default)</option>
            <option value="categorized">Categorized</option>
            <option value="array">Array</option>
        </select>
    </div>
    
    <div class="form-row">
        <label for="node-input-pollingInterval"><i class="fa fa-clock-o"></i> Polling (sec)</label>
        <input type="number" id="node-input-pollingInterval" placeholder="0 = manual trigger only">
    </div>
</script>

<!-- Node Help Text -->
<script type="text/html" data-help-name="goodwe-read">
    <p>Node for reading runtime sensor data from GoodWe inverters.</p>
    
    <h3>Configuration</h3>
    <dl class="message-properties">
        <dt>Config <span class="property-type">goodwe-config</span></dt>
        <dd>Reference to GoodWe configuration node</dd>
        
        <dt>Output Format <span class="property-type">string</span></dt>
        <dd>Data format: flat (default), categorized, or array</dd>
        
        <dt>Polling <span class="property-type">number</span></dt>
        <dd>Auto-polling interval in seconds (0 = disabled, manual trigger only)</dd>
    </dl>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object | any</span></dt>
        <dd>Trigger message. Can include optional sensor filter.</dd>
    </dl>

    <h4>Input Examples</h4>
    <p>Trigger read all sensors:</p>
    <pre>msg.payload = true</pre>
    
    <p>Read specific sensor:</p>
    <pre>msg.payload = { sensor_id: "vpv1" }</pre>
    
    <p>Read multiple sensors:</p>
    <pre>msg.payload = { sensors: ["vpv1", "vpv2", "battery_soc"] }</pre>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object | array</span></dt>
        <dd>Runtime sensor data in the configured format</dd>
        
        <dt>topic <span class="property-type">string</span></dt>
        <dd>Set to "goodwe/runtime_data" (or preserved from input)</dd>
        
        <dt>_timestamp <span class="property-type">string</span></dt>
        <dd>ISO timestamp of the read operation</dd>
        
        <dt>_inverter <span class="property-type">object</span></dt>
        <dd>Inverter metadata (family, host)</dd>
    </dl>

    <h4>Output Format Examples</h4>
    
    <p><strong>Flat format:</strong></p>
    <pre>{
  payload: {
    vpv1: 245.5,
    ipv1: 6.2,
    ppv1: 1522,
    battery_soc: 87,
    ...
  }
}</pre>
    
    <p><strong>Categorized format:</strong></p>
    <pre>{
  payload: {
    pv: { vpv1: 245.5, ipv1: 6.2, ... },
    battery: { battery_soc: 87, ... },
    grid: { vac1: 230.5, ... },
    energy: { e_day: 15.2, ... }
  }
}</pre>
    
    <p><strong>Array format:</strong></p>
    <pre>{
  payload: [
    { id: "vpv1", value: 245.5 },
    { id: "battery_soc", value: 87 },
    ...
  ]
}</pre>

    <h3>Details</h3>
    <p>This node reads runtime sensor data from GoodWe inverters. It can be triggered manually by any input message, or automatically at a configured polling interval.</p>
    
    <p>The output format can be customized to fit your needs:
    <ul>
        <li><strong>Flat</strong> - Simple key-value pairs (best for most use cases)</li>
        <li><strong>Categorized</strong> - Grouped by type (pv, battery, grid, energy, status)</li>
        <li><strong>Array</strong> - Array of sensor objects with metadata</li>
    </ul>
    </p>
</script>
